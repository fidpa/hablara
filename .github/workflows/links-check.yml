name: Link Check

# Configuration constants (DRY - single source of truth)
env:
  DEFAULT_THRESHOLD: '5'
  MAX_BODY_LENGTH: '60000'

on:
  # Daily at 02:00 UTC
  schedule:
    - cron: '0 2 * * *'

  # On PR changes to Markdown files
  pull_request:
    paths:
      - '**.md'
      - '.lycheeignore'
      - '.github/workflows/links-check.yml'

  # Manual execution
  workflow_dispatch:
    inputs:
      fail_threshold:
        description: 'Fail threshold (number of broken links, 0-100)'
        required: false
        default: '5'
        type: number

permissions:
  contents: read
  issues: write

# Prevent parallel executions
concurrency:
  group: link-check-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  link-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Inputs
        if: github.event_name == 'workflow_dispatch'
        env:
          THRESHOLD_INPUT: ${{ github.event.inputs.fail_threshold }}
        run: |
          # Validate threshold is a number between 0 and 100
          if ! [[ "$THRESHOLD_INPUT" =~ ^[0-9]+$ ]]; then
            echo "ERROR: fail_threshold must be a positive integer"
            exit 1
          fi
          if [ "$THRESHOLD_INPUT" -lt 0 ] || [ "$THRESHOLD_INPUT" -gt 100 ]; then
            echo "ERROR: fail_threshold must be between 0 and 100"
            exit 1
          fi
          echo "âœ… Input validation passed: threshold=$THRESHOLD_INPUT"

      - name: Restore Link Cache
        uses: actions/cache@v4
        with:
          path: .lycheecache
          key: lychee-cache-${{ runner.os }}-${{ hashFiles('**/*.md', '.lycheeignore') }}
          restore-keys: |
            lychee-cache-${{ runner.os }}-

      - name: Run Lychee Link Checker
        id: lychee
        continue-on-error: true
        timeout-minutes: 10
        # Pin to v2.1.0 commit SHA for supply chain security
        uses: lycheeverse/lychee-action@7cd0af4c74a61395d455af97419bc4f69bd3e0fb
        with:
          args: >-
            --cache
            --max-cache-age 7d
            --accept 200,204,206,301,302,307,308,410,429,451
            --timeout 20
            --max-retries 3
            --exclude-path 'docs-dev/'
            --exclude-mail
            --exclude "https://raw.githubusercontent.com/${{ github.repository }}/.*"
            --user-agent 'Mozilla/5.0 (compatible; HablaraLinkBot/1.0; +https://github.com/fidpa/hablara)'
            --unique
            --verbose
            '**/*.md'
          format: markdown
          output: lychee-report.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Report Generated
        if: always()
        run: |
          if [ ! -f lychee-report.md ]; then
            echo "âŒ ERROR: Lychee did not generate report file"
            echo "## Link Check Failed" > lychee-report.md
            echo "The link checker crashed or timed out." >> lychee-report.md
            exit 0
          fi

      - name: Parse Results
        id: parse
        if: always()
        run: |
          # Extract number of broken links from Lychee output
          BROKEN_COUNT=0

          if [ -f lychee-report.md ]; then
            # Search for "Broken: X" pattern in report (POSIX-compatible awk)
            if grep -q "Broken:" lychee-report.md; then
              BROKEN_COUNT=$(grep "Broken:" lychee-report.md | awk '{print $2}' | head -1 || echo "0")
            else
              # Fallback: Count âœ— symbols (unique due to --unique flag)
              BROKEN_COUNT=$(grep -c "âœ—" lychee-report.md 2>/dev/null || echo "0")
            fi
          fi

          # Ensure BROKEN_COUNT is a valid integer
          if ! [[ "$BROKEN_COUNT" =~ ^[0-9]+$ ]]; then
            echo "WARNING: Invalid BROKEN_COUNT value: '$BROKEN_COUNT', using 0"
            BROKEN_COUNT=0
          fi

          echo "broken_count=$BROKEN_COUNT" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Found broken links: $BROKEN_COUNT"

      - name: PR Check - Fail on Threshold
        if: always() && github.event_name == 'pull_request'
        env:
          BROKEN_COUNT: ${{ steps.parse.outputs.broken_count }}
          THRESHOLD: ${{ github.event.inputs.fail_threshold || env.DEFAULT_THRESHOLD }}
        run: |
          # Ensure numeric values with defaults
          BROKEN_COUNT="${BROKEN_COUNT:-0}"
          THRESHOLD="${THRESHOLD:-${{ env.DEFAULT_THRESHOLD }}}"

          # Validate numeric input
          if ! [[ "$BROKEN_COUNT" =~ ^[0-9]+$ ]]; then
            echo "WARNING: Invalid BROKEN_COUNT value: '$BROKEN_COUNT', using 0"
            BROKEN_COUNT=0
          fi

          if ! [[ "$THRESHOLD" =~ ^[0-9]+$ ]]; then
            echo "WARNING: Invalid THRESHOLD value: '$THRESHOLD', using ${{ env.DEFAULT_THRESHOLD }}"
            THRESHOLD=${{ env.DEFAULT_THRESHOLD }}
          fi

          if [ "$BROKEN_COUNT" -ge "$THRESHOLD" ]; then
            echo "âŒ FAILED: $BROKEN_COUNT broken links found (threshold: â‰¥$THRESHOLD)"
            echo ""
            echo "Please review the broken links:"
            cat lychee-report.md || echo "No report file found"
            exit 1
          elif [ "$BROKEN_COUNT" -gt 0 ]; then
            echo "âš ï¸  WARNING: $BROKEN_COUNT broken links found (below threshold of $THRESHOLD)"
            echo "PR not blocked, but please review the links:"
            cat lychee-report.md || echo "No report file found"
          else
            echo "âœ… All links are working!"
          fi

      - name: PR Check - Comment Results
        if: always() && github.event_name == 'pull_request' && fromJSON(steps.parse.outputs.broken_count || '0') > 0
        uses: actions/github-script@v7
        env:
          BROKEN_COUNT: ${{ steps.parse.outputs.broken_count }}
          THRESHOLD: ${{ github.event.inputs.fail_threshold || env.DEFAULT_THRESHOLD }}
          MAX_BODY_LENGTH: ${{ env.MAX_BODY_LENGTH }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const brokenCount = parseInt(process.env.BROKEN_COUNT) || 0;
            const threshold = parseInt(process.env.THRESHOLD) || 5;
            const maxBodyLength = parseInt(process.env.MAX_BODY_LENGTH) || 60000;
            const emoji = brokenCount >= threshold ? 'âŒ' : 'âš ï¸';

            // Read and truncate report if too long (GitHub API limit: 65536 bytes)
            let reportContent = '_(No details available)_';
            try {
              reportContent = fs.readFileSync('lychee-report.md', 'utf8');
              if (reportContent.length > maxBodyLength) {
                reportContent = reportContent.substring(0, maxBodyLength) +
                  '\n\n... (truncated, see workflow run for full report)';
              }
            } catch (e) {
              console.log('Report file not found');
            }

            const body = `${emoji} **Link Check Results**\n\n` +
              `Found **${brokenCount}** broken links (threshold: ${threshold})\n\n` +
              `<details>\n<summary>View Details</summary>\n\n\`\`\`\n` +
              reportContent +
              `\n\`\`\`\n</details>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Schedule Check - Create/Update Issue
        if: always() && github.event_name == 'schedule' && fromJSON(steps.parse.outputs.broken_count || '0') > 0
        uses: actions/github-script@v7
        env:
          BROKEN_COUNT: ${{ steps.parse.outputs.broken_count }}
          MAX_BODY_LENGTH: ${{ env.MAX_BODY_LENGTH }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const brokenCount = parseInt(process.env.BROKEN_COUNT) || 0;
            const maxBodyLength = parseInt(process.env.MAX_BODY_LENGTH) || 60000;
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const date = new Date().toISOString().split('T')[0];

            // Read and truncate report if too long (GitHub API limit: 65536 bytes)
            let reportContent = '_(No details available)_';
            try {
              reportContent = fs.readFileSync('lychee-report.md', 'utf8');
              if (reportContent.length > maxBodyLength) {
                reportContent = reportContent.substring(0, maxBodyLength) +
                  '\n\n... (truncated, see workflow run for full report)';
              }
            } catch (e) {
              console.log('Report file not found');
            }

            // Search for existing issue with error handling
            let existingIssue = null;
            try {
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['broken-links', 'automated', 'documentation'],
                state: 'open',
                per_page: 100
              });

              if (issues.length > 1) {
                console.warn(`Warning: Found ${issues.length} open issues, expected 1`);
              }

              existingIssue = issues[0];
            } catch (error) {
              console.error('Failed to list issues:', error);
              // Continue without existing issue
            }

            const runNumber = '${{ github.run_number }}';
            const issueBody = `## ðŸ”— Broken Links Found (${date})

**Count:** ${brokenCount} broken links
**Workflow:** [Link Check #${runNumber}](${runUrl})

### Details

\`\`\`
${reportContent}
\`\`\`

---

_Automatically created by [Link Checker Workflow](${runUrl})_
_Next check: Tomorrow at 02:00 UTC_`;

            try {
              if (existingIssue) {
                // Update existing issue with comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: `## ðŸ“… Update ${date}\n\n${issueBody}`
                });
                console.log(`Issue #${existingIssue.number} updated`);
              } else {
                // Create new issue
                const newIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸ”— Broken Links Found in Documentation`,
                  body: issueBody,
                  labels: ['broken-links', 'automated', 'documentation']
                });
                console.log(`New issue #${newIssue.data.number} created`);
              }
            } catch (error) {
              console.error('Failed to create/update issue:', error);
              throw error;
            }

      - name: Manual Run - Summary
        if: always() && github.event_name == 'workflow_dispatch'
        env:
          BROKEN_COUNT: ${{ steps.parse.outputs.broken_count }}
        run: |
          echo "â„¹ï¸  Manual execution - Info only, no fail"
          echo ""
          echo "ðŸ“Š Broken Links: $BROKEN_COUNT"
          echo ""
          if [ -f lychee-report.md ]; then
            cat lychee-report.md
          fi

      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸ”— Link Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Broken Links:** ${{ steps.parse.outputs.broken_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f lychee-report.md ]; then
            echo "<details><summary>Full Report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat lychee-report.md >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
