# ============================================================================
# Hablará - Windows Release Workflow
# ============================================================================
# Builds Windows x64 installer (MSI/NSIS) for Hablará desktop app.
#
# Usage:
#   1. Go to Actions tab in GitHub
#   2. Select "Windows Release"
#   3. Click "Run workflow"
#   4. Enter version (must match tauri.conf.json)
#
# Prerequisites:
# - whisper.cpp built from source (CMake, pinned v1.7.2)
# - german-turbo model cached (1.62 GB)
#
# Security:
# - All GitHub Actions pinned to commit SHA
# - whisper.cpp commit SHA verification
# - Model SHA256 checksum verification
# ============================================================================

name: Windows Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.4)'
        required: true
        type: string

permissions:
  contents: write
  actions: write

concurrency:
  group: windows-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    name: Build Windows x64 (v${{ inputs.version }})
    runs-on: windows-latest
    timeout-minutes: 45  # Includes whisper.cpp compilation and 1.62 GB model download

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Validate version
        shell: pwsh
        run: |
          $TAURI_VERSION = (Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json).version
          if ($TAURI_VERSION -ne "${{ inputs.version }}") {
            Write-Host "❌ Version mismatch! Input: ${{ inputs.version }}, tauri.conf.json: $TAURI_VERSION"
            exit 1
          }
          Write-Host "✅ Version validated: ${{ inputs.version }}"

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af  # v4.1.0
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@0c17529a66aca453f9227af23103ed11469b1e47  # v4.0.0
        with:
          version: 10

      - name: Setup pnpm cache
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57  # v4.2.0
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Rust cache
        uses: swatinem/rust-cache@aa7c1c80a07a27a84c0aa76d0cef0aad3830e330  # v2.7.8
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ========================================
      # Download ONNX Runtime for Windows (VAD)
      # ========================================
      - name: Cache ONNX Runtime
        id: cache-onnxruntime
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57  # v4.2.0
        with:
          path: src-tauri/resources/onnxruntime.dll
          key: onnxruntime-1.22.0-win-x64

      - name: Download ONNX Runtime
        if: steps.cache-onnxruntime.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ORT_VERSION = "1.22.0"
          $ORT_URL = "https://github.com/microsoft/onnxruntime/releases/download/v${ORT_VERSION}/onnxruntime-win-x64-${ORT_VERSION}.zip"
          $TEMP_ZIP = "$env:TEMP\onnxruntime.zip"
          $TEMP_DIR = "$env:TEMP\onnxruntime"

          Write-Host "Downloading ONNX Runtime v${ORT_VERSION} for Windows x64..."
          $maxRetries = 3
          $success = $false
          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              Write-Host "Download attempt $i of $maxRetries..."
              $ProgressPreference = 'SilentlyContinue'
              Invoke-WebRequest -Uri $ORT_URL -OutFile $TEMP_ZIP -TimeoutSec 120
              $success = $true
              break
            } catch {
              Write-Host "Attempt $i failed: $_"
              if ($i -lt $maxRetries) { Start-Sleep -Seconds 5 }
            }
          }
          if (-not $success) {
            Write-Host "ERROR: Failed to download ONNX Runtime after $maxRetries attempts"
            exit 1
          }

          Write-Host "Extracting..."
          Expand-Archive -Path $TEMP_ZIP -DestinationPath $TEMP_DIR -Force

          # Copy DLL to resources directory
          $DLL_SOURCE = Get-ChildItem -Path $TEMP_DIR -Recurse -Filter "onnxruntime.dll" | Select-Object -First 1
          if (-not $DLL_SOURCE) {
            Write-Host "ERROR: onnxruntime.dll not found in extracted archive"
            exit 1
          }

          New-Item -ItemType Directory -Force -Path "src-tauri/resources"
          Copy-Item $DLL_SOURCE.FullName "src-tauri/resources/onnxruntime.dll"

          $fileSize = (Get-Item "src-tauri/resources/onnxruntime.dll").Length
          Write-Host "ONNX Runtime DLL: $($fileSize / 1MB) MB"

          # SECURITY: Verify SHA256 checksum of extracted DLL
          $EXPECTED_ORT_SHA256 = "579b636403983254346a5c1d80bd28f1519cd1e284cd204f8d4ff41f8d711559"
          $ACTUAL_ORT_SHA256 = (Get-FileHash -Path "src-tauri/resources/onnxruntime.dll" -Algorithm SHA256).Hash.ToLower()

          if ($EXPECTED_ORT_SHA256 -eq "REPLACE_WITH_KNOWN_GOOD_SHA256") {
            Write-Host "Current onnxruntime.dll SHA256: $ACTUAL_ORT_SHA256"
            if ($env:GITHUB_REF -like "refs/tags/v*") {
              Write-Host "::error::onnxruntime.dll SHA256 checksum not configured! Failing release build."
              exit 1
            }
            Write-Host "::warning::onnxruntime.dll SHA256 not configured. Add: $ACTUAL_ORT_SHA256"
          } elseif ($ACTUAL_ORT_SHA256 -ne $EXPECTED_ORT_SHA256.ToLower()) {
            Write-Host "ERROR: onnxruntime.dll checksum mismatch!"
            Write-Host "Expected: $EXPECTED_ORT_SHA256"
            Write-Host "Actual:   $ACTUAL_ORT_SHA256"
            exit 1
          } else {
            Write-Host "onnxruntime.dll SHA256 verified: OK"
          }

          # Cleanup
          Remove-Item -Recurse -Force $TEMP_DIR, $TEMP_ZIP -ErrorAction SilentlyContinue

          Write-Host "ONNX Runtime v${ORT_VERSION} ready for bundling"

      - name: Add ONNX Runtime to Tauri resources
        shell: pwsh
        run: |
          # Patch tauri.conf.json to include onnxruntime.dll in resources (Windows only)
          $config = Get-Content "src-tauri/tauri.conf.json" -Raw | ConvertFrom-Json
          $resources = [System.Collections.ArrayList]@($config.bundle.resources)
          if ($resources -notcontains "resources/onnxruntime.dll") {
            $resources.Add("resources/onnxruntime.dll") | Out-Null
            $config.bundle.resources = $resources.ToArray()
            $config | ConvertTo-Json -Depth 10 | Set-Content "src-tauri/tauri.conf.json"
            Write-Host "Added onnxruntime.dll to Tauri resources"
          }
          Write-Host "Tauri resources: $($config.bundle.resources -join ', ')"

      # ========================================
      # Build whisper.cpp for Windows
      # ========================================
      - name: Cache whisper model
        id: cache-whisper-model
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57  # v4.2.0
        with:
          path: src-tauri/models/ggml-german-turbo.bin
          key: whisper-german-turbo-1.62gb

      - name: Download whisper german-turbo model
        if: steps.cache-whisper-model.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path src-tauri/models
          Write-Host "Downloading german-turbo model (1.62 GB)..."

          # Download with retry logic
          $maxRetries = 3
          $retryDelay = 5
          $success = $false

          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              Write-Host "Download attempt $i of $maxRetries..."
              $ProgressPreference = 'SilentlyContinue'
              Invoke-WebRequest -Uri "https://huggingface.co/cstr/whisper-large-v3-turbo-german-ggml/resolve/main/ggml-model.bin" -OutFile "src-tauri/models/ggml-german-turbo.bin" -TimeoutSec 600
              $success = $true
              break
            } catch {
              Write-Host "Attempt $i failed: $_"
              if ($i -lt $maxRetries) {
                Write-Host "Retrying in $retryDelay seconds..."
                Start-Sleep -Seconds $retryDelay
              }
            }
          }

          if (-not $success) {
            Write-Host "ERROR: Failed to download model after $maxRetries attempts"
            exit 1
          }

          # Verify file size (should be approximately 1.62 GB)
          $fileSize = (Get-Item "src-tauri/models/ggml-german-turbo.bin").Length
          $minSize = 1600000000
          if ($fileSize -lt $minSize) {
            Write-Host "ERROR: Downloaded file too small: $fileSize bytes"
            exit 1
          }

          # SECURITY: Verify SHA256 checksum
          $EXPECTED_SHA256 = "REPLACE_WITH_KNOWN_GOOD_SHA256"
          $ACTUAL_SHA256 = (Get-FileHash -Path "src-tauri/models/ggml-german-turbo.bin" -Algorithm SHA256).Hash.ToLower()

          if ($EXPECTED_SHA256 -eq "REPLACE_WITH_KNOWN_GOOD_SHA256") {
            Write-Host "Current SHA256: $ACTUAL_SHA256"
            # For release builds (v* tags), checksum MUST be configured
            if ($env:GITHUB_REF -like "refs/tags/v*") {
              Write-Host "::error::SHA256 checksum not configured! Failing release build for security."
              exit 1
            }
            Write-Host "::warning::SHA256 checksum not configured. Add: $ACTUAL_SHA256"
          } elseif ($ACTUAL_SHA256 -ne $EXPECTED_SHA256.ToLower()) {
            Write-Host "ERROR: Model checksum mismatch!"
            Write-Host "Expected: $EXPECTED_SHA256"
            Write-Host "Actual:   $ACTUAL_SHA256"
            exit 1
          } else {
            Write-Host "SHA256 checksum verified: OK"
          }

          Get-Item src-tauri/models/ggml-german-turbo.bin
          Write-Host "Model downloaded and verified"

      - name: Build whisper.cpp for Windows
        shell: pwsh
        run: |
          Write-Host "Cloning whisper.cpp (pinned to v1.7.2)..."
          git clone --depth 1 --branch v1.7.2 https://github.com/ggml-org/whisper.cpp.git C:\whisper-build
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Failed to clone whisper.cpp"
            exit 1
          }
          Set-Location C:\whisper-build

          # SECURITY: Verify commit SHA to prevent supply chain attacks
          $EXPECTED_SHA = "6266a9f9e56a5b925e9892acf650f3eb1245814d"  # v1.7.2
          $ACTUAL_SHA = git rev-parse HEAD

          if ($ACTUAL_SHA -ne $EXPECTED_SHA) {
            Write-Host "ERROR: whisper.cpp commit SHA mismatch!"
            Write-Host "Expected: $EXPECTED_SHA"
            Write-Host "Actual:   $ACTUAL_SHA"
            Write-Host "This could indicate a compromised repository or incorrect tag."
            exit 1
          }
          Write-Host "Commit SHA verified: OK (v1.7.2)"

          Write-Host "Building for x86_64 (static linking)..."
          cmake -B build -S . `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED_LIBS=OFF `
            -DWHISPER_BUILD_TESTS=OFF `
            -DWHISPER_BUILD_EXAMPLES=ON

          # Build with parallelization
          $cpuCount = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors
          cmake --build build --config Release --parallel $cpuCount

          # Find binary (name varies between whisper.cpp versions)
          Write-Host "Searching for whisper binary..."
          $binaryPaths = @(
            "build/bin/Release/main.exe",
            "build/bin/Release/whisper-cli.exe",
            "build/bin/main.exe",
            "build/bin/whisper-cli.exe"
          )

          $BINARY = $null
          foreach ($path in $binaryPaths) {
            if (Test-Path $path) {
              $BINARY = $path
              Write-Host "Found binary at: $BINARY"
              break
            }
          }

          if (-not $BINARY) {
            Write-Host "ERROR: No whisper binary found!"
            Write-Host "Build directory contents:"
            Get-ChildItem -Recurse build/bin -ErrorAction SilentlyContinue | Select-Object -First 20
            exit 1
          }

          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE/src-tauri/binaries"
          Copy-Item $BINARY "$env:GITHUB_WORKSPACE/src-tauri/binaries/whisper-x86_64-pc-windows-msvc.exe"

          # Verify static linking (no whisper/ggml DLL dependencies)
          Write-Host "Verifying static linking..."
          $dumpbinPath = Get-ChildItem "C:\Program Files\Microsoft Visual Studio" -Recurse -Filter "dumpbin.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($dumpbinPath) {
            $deps = & $dumpbinPath.FullName /dependents $BINARY 2>$null
            if ($deps -match 'whisper|ggml') {
              Write-Host "ERROR: Binary has whisper/ggml DLL dependencies (not statically linked)!"
              & $dumpbinPath.FullName /dependents $BINARY
              exit 1
            }
            Write-Host "Binary is statically linked (verified via dumpbin)"
          } else {
            Write-Host "::warning::dumpbin not found, skipping static linking verification"
          }

          Write-Host "whisper.cpp built for Windows"
          Get-ChildItem "$env:GITHUB_WORKSPACE/src-tauri/binaries/"

      # ========================================
      # Build Tauri Windows App
      # ========================================
      - name: Build Tauri Windows app
        uses: tauri-apps/tauri-action@2773e489dd94df5e87641131f67916b46ef3a8d5  # v0.5.15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v${{ inputs.version }}
          releaseName: 'Hablara v${{ inputs.version }}'
          releaseDraft: true
          prerelease: false
          args: --target x86_64-pc-windows-msvc

      - name: Upload artifacts
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # v4.5.0
        with:
          name: windows-build
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
