# ============================================================================
# Hablar√° - GitHub Release Workflow
# ============================================================================
# Builds a Universal Binary DMG for macOS (arm64 + x86_64) on FREE runners.
#
# Trigger: Push a tag matching 'v*' (e.g., v1.0.3)
#
# Note: Uses macos-14 (ARM64) runner to cross-compile x86_64 (FREE on GitHub)
#
# TODO: Windows support (Phase B)
# - Windows x64 build will be added as a separate job
# - Requires whisper-x86_64-pc-windows-msvc.exe binary
# - See .github/workflows/windows-build.yml.disabled for template
# ============================================================================

name: GitHub Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  APP_NAME: "Hablara"

jobs:
  build-universal:
    name: Build Universal macOS
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Setup Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ========================================
      # Apple Code Signing & Notarization Setup
      # ========================================
      # Required Secrets:
      #   - DEVELOPER_ID_CERT_BASE64: Developer ID Application certificate (.p12, base64)
      #   - DEVELOPER_ID_CERT_PASSWORD: Password for the .p12 file
      #   - ASC_API_*: App Store Connect API credentials (for notarization)
      # ========================================
      - name: Import Developer ID Certificate
        env:
          DEVELOPER_ID_CERT: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Decode certificate
          echo "$DEVELOPER_ID_CERT" | base64 --decode > $RUNNER_TEMP/certificate.p12

          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $RUNNER_TEMP/certificate.p12 -k $KEYCHAIN_PATH \
            -P "$DEVELOPER_ID_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          # Set keychain permissions
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Cleanup
          rm $RUNNER_TEMP/certificate.p12
          echo "‚úÖ Developer ID Certificate imported"

      - name: Setup App Store Connect API Key
        env:
          ASC_API_PRIVATE_KEY: ${{ secrets.ASC_API_PRIVATE_KEY_BASE64 }}
        run: |
          mkdir -p ~/private_keys
          echo "$ASC_API_PRIVATE_KEY" | base64 --decode > ~/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8
          echo "‚úÖ App Store Connect API Key configured"

      # ========================================
      # Build whisper.cpp & Download Model
      # ========================================
      - name: Cache whisper model
        id: cache-whisper-model
        uses: actions/cache@v4
        with:
          path: src-tauri/models/ggml-german-turbo.bin
          key: whisper-german-turbo-1.62gb

      - name: Download whisper german-turbo model
        if: steps.cache-whisper-model.outputs.cache-hit != 'true'
        run: |
          mkdir -p src-tauri/models
          echo "‚¨áÔ∏è Downloading german-turbo model (1.62 GB)..."
          curl -L --progress-bar \
            "https://huggingface.co/cstr/whisper-large-v3-turbo-german-ggml/resolve/main/ggml-model.bin" \
            -o src-tauri/models/ggml-german-turbo.bin
          ls -lh src-tauri/models/ggml-german-turbo.bin
          echo "‚úÖ Model downloaded"

      - name: Build whisper.cpp for Universal Binary
        run: |
          set -e
          echo "üì¶ Cloning whisper.cpp..."
          git clone --depth 1 https://github.com/ggml-org/whisper.cpp.git /tmp/whisper-build
          cd /tmp/whisper-build

          # Build for aarch64 (Apple Silicon with Metal)
          echo "üî® Building for aarch64 (Metal)..."
          cmake -B build-arm64 \
            -S . \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DGGML_METAL=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DWHISPER_BUILD_EXAMPLES=ON

          cmake --build build-arm64 --config Release -j$(sysctl -n hw.ncpu)

          # Build for x86_64 (Intel) - cross-compile on ARM64 runner (FREE!)
          echo "üî® Building for x86_64..."
          cmake -B build-x64 \
            -S . \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DWHISPER_BUILD_EXAMPLES=ON \
            -DGGML_NATIVE=OFF \
            -DGGML_METAL=OFF

          cmake --build build-x64 --config Release -j$(sysctl -n hw.ncpu)

          # Verify binaries
          ARM_BIN="build-arm64/bin/whisper-cli"
          X64_BIN="build-x64/bin/whisper-cli"

          if [ ! -f "$ARM_BIN" ] || [ ! -f "$X64_BIN" ]; then
            echo "‚ùå Binaries not found"
            exit 1
          fi

          echo "üîç Verifying architectures..."
          lipo -info "$ARM_BIN"
          lipo -info "$X64_BIN"

          # Install to Tauri binaries
          mkdir -p $GITHUB_WORKSPACE/src-tauri/binaries
          cp "$ARM_BIN" $GITHUB_WORKSPACE/src-tauri/binaries/whisper-aarch64-apple-darwin
          cp "$X64_BIN" $GITHUB_WORKSPACE/src-tauri/binaries/whisper-x86_64-apple-darwin
          chmod +x $GITHUB_WORKSPACE/src-tauri/binaries/whisper-*

          echo "‚úÖ whisper.cpp built for Universal Binary"
          ls -lh $GITHUB_WORKSPACE/src-tauri/binaries/

          # Add x86_64 resource to tauri.conf.json
          jq '.bundle.resources += ["binaries/whisper-x86_64-apple-darwin"]' \
            $GITHUB_WORKSPACE/src-tauri/tauri.conf.json > /tmp/tauri.conf.json.tmp
          mv /tmp/tauri.conf.json.tmp $GITHUB_WORKSPACE/src-tauri/tauri.conf.json
          echo "‚úÖ Updated tauri.conf.json for universal binary"

      - name: Sign whisper binaries for Notarization
        run: |
          SIGNING_IDENTITY="Developer ID Application: Marc Allgeier (94H68V6M99)"
          BINARIES_DIR="$GITHUB_WORKSPACE/src-tauri/binaries"

          echo "üîè Signing whisper binaries with Developer ID..."

          for binary in "$BINARIES_DIR"/whisper-*; do
            echo "  Signing $(basename "$binary")..."
            codesign --force --options runtime --timestamp \
              --sign "$SIGNING_IDENTITY" \
              "$binary"
          done

          echo "‚úÖ Whisper binaries signed"

          # Verify signatures
          echo "üîç Verifying signatures..."
          for binary in "$BINARIES_DIR"/whisper-*; do
            codesign -dv --verbose=2 "$binary" 2>&1 | head -5
          done

      # ========================================
      # Build Tauri Universal App
      # ========================================
      - name: Build Tauri universal app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Code Signing
          APPLE_SIGNING_IDENTITY: "Developer ID Application: Marc Allgeier (94H68V6M99)"
          # Notarization via App Store Connect API (preferred for CI)
          APPLE_API_ISSUER: ${{ secrets.ASC_API_ISSUER_ID }}
          APPLE_API_KEY: ${{ secrets.ASC_API_KEY_ID }}
          APPLE_API_KEY_PATH: ~/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Hablar√° ${{ github.ref_name }}'
          releaseBody: |
            ## Hablar√° ${{ github.ref_name }}

            Voice Intelligence Platform - Sprache aufnehmen, transkribieren und KI-gest√ºtzt anreichern.

            ### Installation (macOS)

            **Direkter Download:**
            - `Hablara_*_universal.dmg` - Universal Binary (Apple Silicon + Intel)

            **Via Homebrew:**
            ```bash
            brew install --cask fidpa/hablara/hablara
            ```

            ### Voraussetzungen

            - macOS 10.15 oder neuer
            - [Ollama](https://ollama.com) f√ºr lokale LLM-Verarbeitung (optional)

            ### Schnellstart

            ```bash
            # Ollama Setup (optional, f√ºr lokale KI)
            brew install ollama
            ollama pull qwen2.5:7b
            ```

            ### Was ist neu?

            Siehe [CHANGELOG.md](https://github.com/fidpa/hablara/blob/main/CHANGELOG.md)
          releaseDraft: true
          prerelease: false
          args: --target universal-apple-darwin --bundles dmg

  publish:
    name: Publish Release
    needs: build-universal
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Cask
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Bump Homebrew Cask
        uses: macauley/action-homebrew-bump-cask@v1
        with:
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          cask: hablara
          tap: fidpa/hablara
          livecheck: true
