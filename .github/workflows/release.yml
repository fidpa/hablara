# ============================================================================
# Hablar√° - GitHub Release Workflow
# ============================================================================
# Builds a Universal Binary DMG for macOS (arm64 + x86_64) on FREE runners.
#
# Trigger: Push a tag matching 'v*' (e.g., v1.0.3)
#
# Note: Uses macos-14 (ARM64) runner to cross-compile x86_64 (FREE on GitHub)
#
# TODO: Windows support (Phase B)
# - Windows x64 build will be added as a separate job
# - Requires whisper-x86_64-pc-windows-msvc.exe binary
# - See .github/workflows/windows-build.yml.disabled for template
# ============================================================================

name: GitHub Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      debug_build:
        description: 'Run debug ARM64-only build'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

env:
  APP_NAME: "Hablara"

jobs:
  build-universal:
    name: Build Universal macOS
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Setup Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ========================================
      # Apple Code Signing & Notarization Setup
      # ========================================
      # Required Secrets:
      #   - DEVELOPER_ID_CERT_BASE64: Developer ID Application certificate (.p12, base64)
      #   - DEVELOPER_ID_CERT_PASSWORD: Password for the .p12 file
      #   - ASC_API_*: App Store Connect API credentials (for notarization)
      # ========================================
      - name: Import Developer ID Certificate
        env:
          DEVELOPER_ID_CERT: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Decode certificate
          echo "$DEVELOPER_ID_CERT" | base64 --decode > $RUNNER_TEMP/certificate.p12

          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $RUNNER_TEMP/certificate.p12 -k $KEYCHAIN_PATH \
            -P "$DEVELOPER_ID_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          # Set keychain permissions
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Cleanup
          rm $RUNNER_TEMP/certificate.p12
          echo "‚úÖ Developer ID Certificate imported"

      - name: Setup App Store Connect API Key
        env:
          ASC_API_PRIVATE_KEY: ${{ secrets.ASC_API_PRIVATE_KEY_BASE64 }}
        run: |
          mkdir -p ~/private_keys
          echo "$ASC_API_PRIVATE_KEY" | base64 --decode > ~/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8
          echo "‚úÖ App Store Connect API Key configured"

      # ========================================
      # Build whisper.cpp & Download Model
      # ========================================
      - name: Cache whisper model
        id: cache-whisper-model
        uses: actions/cache@v4
        with:
          path: src-tauri/models/ggml-german-turbo.bin
          key: whisper-german-turbo-1.62gb

      - name: Download whisper german-turbo model
        if: steps.cache-whisper-model.outputs.cache-hit != 'true'
        run: |
          mkdir -p src-tauri/models
          echo "‚¨áÔ∏è Downloading german-turbo model (1.62 GB)..."
          curl -L --progress-bar \
            "https://huggingface.co/cstr/whisper-large-v3-turbo-german-ggml/resolve/main/ggml-model.bin" \
            -o src-tauri/models/ggml-german-turbo.bin
          ls -lh src-tauri/models/ggml-german-turbo.bin
          echo "‚úÖ Model downloaded"

      - name: Build whisper.cpp for Universal Binary
        run: |
          set -e
          echo "üì¶ Cloning whisper.cpp (pinned to v1.7.2)..."
          git clone --depth 1 --branch v1.7.2 https://github.com/ggml-org/whisper.cpp.git /tmp/whisper-build
          cd /tmp/whisper-build

          # SECURITY: Verify commit SHA to prevent supply chain attacks
          EXPECTED_SHA="6266a9f9e56a5b925e9892acf650f3eb1245814d"  # v1.7.2
          ACTUAL_SHA=$(git rev-parse HEAD)
          if [ "$ACTUAL_SHA" != "$EXPECTED_SHA" ]; then
            echo "‚ùå whisper.cpp commit SHA mismatch!"
            echo "Expected: $EXPECTED_SHA"
            echo "Actual:   $ACTUAL_SHA"
            exit 1
          fi
          echo "‚úÖ Commit SHA verified: OK (v1.7.2)"

          # Build for aarch64 (Apple Silicon with Metal)
          # BUILD_SHARED_LIBS=OFF ensures static linking (no @rpath dylib dependencies)
          echo "üî® Building for aarch64 (Metal, static)..."
          cmake -B build-arm64 \
            -S . \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DGGML_METAL=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_EXAMPLES=ON

          cmake --build build-arm64 --config Release -j$(sysctl -n hw.ncpu)

          # Build for x86_64 (Intel) - cross-compile on ARM64 runner (FREE!)
          echo "üî® Building for x86_64 (static)..."
          cmake -B build-x64 \
            -S . \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_EXAMPLES=ON \
            -DGGML_NATIVE=OFF \
            -DGGML_METAL=OFF

          cmake --build build-x64 --config Release -j$(sysctl -n hw.ncpu)

          # Find binaries (whisper.cpp v1.7.x uses 'main' for CLI)
          echo "üîç Searching for whisper binary..."
          ARM_BIN=""
          X64_BIN=""
          for name in "build-arm64/bin/whisper-cli" "build-arm64/bin/main"; do
            if [ -f "$name" ]; then ARM_BIN="$name"; break; fi
          done
          for name in "build-x64/bin/whisper-cli" "build-x64/bin/main"; do
            if [ -f "$name" ]; then X64_BIN="$name"; break; fi
          done

          if [ -z "$ARM_BIN" ] || [ -z "$X64_BIN" ]; then
            echo "‚ùå Binaries not found"
            echo "arm64 build/bin contents:"
            ls -la build-arm64/bin/ || true
            echo "x64 build/bin contents:"
            ls -la build-x64/bin/ || true
            exit 1
          fi

          echo "üîç Verifying architectures..."
          lipo -info "$ARM_BIN"
          lipo -info "$X64_BIN"

          # Verify static linking (no @rpath dependencies)
          echo "üîç Verifying static linking..."
          if otool -L "$ARM_BIN" | grep -q '@rpath'; then
            echo "‚ùå ERROR: arm64 binary has @rpath dependencies (not statically linked)!"
            otool -L "$ARM_BIN"
            exit 1
          fi
          if otool -L "$X64_BIN" | grep -q '@rpath'; then
            echo "‚ùå ERROR: x64 binary has @rpath dependencies (not statically linked)!"
            otool -L "$X64_BIN"
            exit 1
          fi
          echo "‚úÖ Both binaries are statically linked"

          # Install to Tauri binaries
          mkdir -p $GITHUB_WORKSPACE/src-tauri/binaries
          cp "$ARM_BIN" $GITHUB_WORKSPACE/src-tauri/binaries/whisper-aarch64-apple-darwin
          cp "$X64_BIN" $GITHUB_WORKSPACE/src-tauri/binaries/whisper-x86_64-apple-darwin
          chmod +x $GITHUB_WORKSPACE/src-tauri/binaries/whisper-*

          echo "‚úÖ whisper.cpp built for Universal Binary"
          ls -lh $GITHUB_WORKSPACE/src-tauri/binaries/

          # Add x86_64 resource to tauri.conf.json
          jq '.bundle.resources += ["binaries/whisper-x86_64-apple-darwin"]' \
            $GITHUB_WORKSPACE/src-tauri/tauri.conf.json > /tmp/tauri.conf.json.tmp
          mv /tmp/tauri.conf.json.tmp $GITHUB_WORKSPACE/src-tauri/tauri.conf.json
          echo "‚úÖ Updated tauri.conf.json for universal binary"

      - name: Sign whisper binaries for Notarization
        run: |
          SIGNING_IDENTITY="Developer ID Application: Marc Allgeier (94H68V6M99)"
          BINARIES_DIR="$GITHUB_WORKSPACE/src-tauri/binaries"

          echo "üîè Signing whisper binaries with Developer ID..."

          for binary in "$BINARIES_DIR"/whisper-*; do
            echo "  Signing $(basename "$binary")..."
            codesign --force --options runtime --timestamp \
              --sign "$SIGNING_IDENTITY" \
              "$binary"
          done

          echo "‚úÖ Whisper binaries signed"

          # Verify signatures
          echo "üîç Verifying signatures..."
          for binary in "$BINARIES_DIR"/whisper-*; do
            codesign -dv --verbose=2 "$binary" 2>&1 | head -5
          done

      # ========================================
      # Build Frontend (explicit step for debugging)
      # ========================================
      - name: Build frontend (Next.js)
        run: |
          echo "üî® Building Next.js frontend..."
          pnpm run build

          echo ""
          echo "=== Verify out/ directory exists ==="
          if [ -d "out" ]; then
            echo "‚úÖ out/ directory exists"
            ls -la out/ | head -20
            echo ""
            echo "=== Check for index.html ==="
            if [ -f "out/index.html" ]; then
              echo "‚úÖ index.html exists ($(wc -c < out/index.html) bytes)"
            else
              echo "‚ùå ERROR: index.html NOT FOUND!"
              exit 1
            fi
            echo ""
            echo "=== Check for _next/ ==="
            if [ -d "out/_next" ]; then
              echo "‚úÖ _next/ directory exists"
              find out/_next -type f | wc -l | xargs echo "   Files in _next/:"
            else
              echo "‚ùå ERROR: _next/ directory NOT FOUND!"
              exit 1
            fi
          else
            echo "‚ùå ERROR: out/ directory NOT FOUND!"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi

      # ========================================
      # Build Tauri Universal App (Manual - workaround for bundler bug)
      # ========================================
      - name: Build Tauri universal app
        run: pnpm tauri build --target universal-apple-darwin --bundles app

      # Workaround: Tauri bundler bug doesn't copy frontend in Universal Binary builds
      - name: Copy frontend to bundle (Universal Binary workaround)
        run: |
          APP_PATH="src-tauri/target/universal-apple-darwin/release/bundle/macos/Hablara.app"
          UP_DIR="$APP_PATH/Contents/Resources/_up_"

          echo "üîß Manual frontend copy (Tauri Universal Binary bundler workaround)"

          if [ ! -d "out" ]; then
            echo "‚ùå ERROR: out/ directory not found!"
            exit 1
          fi

          if [ -f "$UP_DIR/index.html" ]; then
            echo "‚úÖ Frontend already present in bundle"
          else
            echo "‚ö†Ô∏è Frontend missing, copying manually..."
            mkdir -p "$UP_DIR"
            cp -r out/* "$UP_DIR/"
            echo "‚úÖ Frontend copied"
          fi

          ls -la "$UP_DIR" | head -10

      - name: Verify frontend in bundle
        run: |
          APP_PATH="src-tauri/target/universal-apple-darwin/release/bundle/macos/Hablara.app"
          if [ ! -f "$APP_PATH/Contents/Resources/_up_/index.html" ]; then
            echo "‚ùå Frontend still missing after copy!"
            exit 1
          fi
          echo "‚úÖ Frontend verified in bundle"

      - name: Set display name with accent
        run: |
          APP_PATH="src-tauri/target/universal-apple-darwin/release/bundle/macos/Hablara.app"
          plutil -replace CFBundleDisplayName -string "Hablar√°" "$APP_PATH/Contents/Info.plist"
          plutil -replace CFBundleName -string "Hablar√°" "$APP_PATH/Contents/Info.plist"
          echo "‚úÖ CFBundleDisplayName and CFBundleName set to 'Hablar√°'"

      - name: Sign app bundle
        env:
          APPLE_SIGNING_IDENTITY: "Developer ID Application: Marc Allgeier (94H68V6M99)"
        run: |
          APP_PATH="src-tauri/target/universal-apple-darwin/release/bundle/macos/Hablara.app"

          # Sign whisper binaries first
          for binary in "$APP_PATH/Contents/Resources/binaries/whisper-"*; do
            if [ -f "$binary" ]; then
              echo "Signing: $binary"
              codesign --force --options runtime --sign "$APPLE_SIGNING_IDENTITY" "$binary"
            fi
          done

          # Sign main binary (use direct distribution entitlements - NO sandbox)
          codesign --force --options runtime --sign "$APPLE_SIGNING_IDENTITY" \
            --entitlements src-tauri/entitlements-direct.plist \
            "$APP_PATH/Contents/MacOS/hablara"

          # Sign the app bundle (use direct distribution entitlements - NO sandbox)
          codesign --force --options runtime --sign "$APPLE_SIGNING_IDENTITY" \
            --entitlements src-tauri/entitlements-direct.plist \
            "$APP_PATH"

          # Verify
          codesign --verify --deep --strict "$APP_PATH"
          echo "‚úÖ App signed and verified"

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          APP_PATH="src-tauri/target/universal-apple-darwin/release/bundle/macos/Hablara.app"

          # Verify app bundle exists before DMG creation
          if [ ! -d "$APP_PATH" ]; then
            echo "::error::App bundle not found at $APP_PATH"
            exit 1
          fi

          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          DMG_NAME="Hablara_${VERSION}_universal.dmg"
          DMG_PATH="src-tauri/target/universal-apple-darwin/release/bundle/dmg/$DMG_NAME"

          mkdir -p "$(dirname "$DMG_PATH")"

          # Staging directory with app for create-dmg
          STAGING_DIR=$(mktemp -d)
          cp -R "$APP_PATH" "$STAGING_DIR/"

          # Create professional DMG with Applications symlink and icon layout
          # --sandbox-safe: creates .DS_Store internally (no Finder/AppleScript needed for headless CI)
          # Layout: App icon left (180,190), Applications symlink right (480,190)
          # Exit code 2 = disk image size was adjusted (not an error)
          create-dmg \
            --volname "Hablar√°" \
            --volicon "$GITHUB_WORKSPACE/icons/icon.icns" \
            --sandbox-safe \
            --window-pos 200 120 \
            --window-size 660 400 \
            --icon-size 100 \
            --icon "Hablara.app" 180 190 \
            --hide-extension "Hablara.app" \
            --app-drop-link 480 190 \
            --text-size 14 \
            --no-internet-enable \
            --format UDZO \
            --hdiutil-retries 5 \
            "$DMG_PATH" \
            "$STAGING_DIR/" \
            || test $? -eq 2

          rm -rf "$STAGING_DIR"

          echo "‚úÖ DMG created: $DMG_PATH"
          ls -lh "$DMG_PATH"

          # Export path for later steps
          echo "DMG_PATH=$DMG_PATH" >> $GITHUB_ENV
          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV

      - name: Sign DMG
        env:
          APPLE_SIGNING_IDENTITY: "Developer ID Application: Marc Allgeier (94H68V6M99)"
        run: |
          codesign --force --sign "$APPLE_SIGNING_IDENTITY" "$DMG_PATH"
          codesign --verify "$DMG_PATH"
          echo "‚úÖ DMG signed"

      - name: Notarize DMG
        env:
          APPLE_API_ISSUER: ${{ secrets.ASC_API_ISSUER_ID }}
          APPLE_API_KEY: ${{ secrets.ASC_API_KEY_ID }}
        run: |
          echo "üîè Submitting DMG for notarization..."
          xcrun notarytool submit "$DMG_PATH" \
            --key ~/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8 \
            --key-id "$APPLE_API_KEY" \
            --issuer "$APPLE_API_ISSUER" \
            --wait

          echo "üìé Stapling notarization ticket..."
          xcrun stapler staple "$DMG_PATH"

          echo "‚úÖ DMG notarized and stapled"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"

          # Create release if it doesn't exist
          if ! gh release view "$VERSION" &>/dev/null; then
            gh release create "$VERSION" \
              --title "Hablar√° $VERSION" \
              --draft \
              --notes "## Hablar√° $VERSION

          Voice Intelligence Platform - Sprache aufnehmen, transkribieren und KI-gest√ºtzt anreichern.

          ### Installation (macOS)

          **Direkter Download:**
          - \`Hablara_*_universal.dmg\` - Universal Binary (Apple Silicon + Intel)

          **Via Homebrew:**
          \`\`\`bash
          brew install --cask fidpa/hablara/hablara
          \`\`\`

          ### Voraussetzungen

          - macOS 10.15 oder neuer
          - [Ollama](https://ollama.com) f√ºr lokale LLM-Verarbeitung (optional)

          ### Was ist neu?

          Siehe [CHANGELOG.md](https://github.com/fidpa/hablara/blob/main/CHANGELOG.md)"
          fi

          # Upload DMG
          gh release upload "$VERSION" "$DMG_PATH" --clobber

          echo "‚úÖ Release created and DMG uploaded"

  # ========================================
  # DEBUG: ARM64-only build to test if Universal Binary is the issue
  # ========================================
  build-arm64-debug:
    name: Debug ARM64-only Build
    runs-on: macos-14
    # Only run if universal build fails, or manually triggered with debug_build=true
    if: failure() || (github.event_name == 'workflow_dispatch' && inputs.debug_build == true)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache whisper model
        id: cache-whisper-model-arm64
        uses: actions/cache@v4
        with:
          path: src-tauri/models/ggml-german-turbo.bin
          key: whisper-german-turbo-1.62gb

      - name: Download whisper model (if not cached)
        if: steps.cache-whisper-model-arm64.outputs.cache-hit != 'true'
        run: |
          mkdir -p src-tauri/models
          curl -L --progress-bar \
            "https://huggingface.co/cstr/whisper-large-v3-turbo-german-ggml/resolve/main/ggml-model.bin" \
            -o src-tauri/models/ggml-german-turbo.bin

      - name: Build whisper.cpp (ARM64 only)
        run: |
          git clone --depth 1 --branch v1.7.2 https://github.com/ggml-org/whisper.cpp.git /tmp/whisper-build
          cd /tmp/whisper-build
          # SECURITY: Verify commit SHA
          EXPECTED_SHA="6266a9f9e56a5b925e9892acf650f3eb1245814d"
          ACTUAL_SHA=$(git rev-parse HEAD)
          if [ "$ACTUAL_SHA" != "$EXPECTED_SHA" ]; then
            echo "‚ùå whisper.cpp commit SHA mismatch! Expected: $EXPECTED_SHA, Actual: $ACTUAL_SHA"
            exit 1
          fi
          echo "‚úÖ SHA verified (v1.7.2)"
          cmake -B build \
            -S . \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DGGML_METAL=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_EXAMPLES=ON
          cmake --build build --config Release -j$(sysctl -n hw.ncpu)
          # Find binary (v1.7.x uses 'main', newer uses 'whisper-cli')
          BINARY=""
          for name in "build/bin/whisper-cli" "build/bin/main"; do
            if [ -f "$name" ]; then BINARY="$name"; break; fi
          done
          if [ -z "$BINARY" ]; then
            echo "‚ùå No whisper binary found!"
            ls -la build/bin/ || true
            exit 1
          fi
          mkdir -p $GITHUB_WORKSPACE/src-tauri/binaries
          cp "$BINARY" $GITHUB_WORKSPACE/src-tauri/binaries/whisper-aarch64-apple-darwin
          chmod +x $GITHUB_WORKSPACE/src-tauri/binaries/whisper-*
          # Verify static linking
          if otool -L $GITHUB_WORKSPACE/src-tauri/binaries/whisper-aarch64-apple-darwin | grep -q '@rpath'; then
            echo "‚ùå Binary has @rpath dependencies!"
            otool -L $GITHUB_WORKSPACE/src-tauri/binaries/whisper-aarch64-apple-darwin
            exit 1
          fi
          echo "‚úÖ Statically linked"

      - name: Build frontend explicitly
        run: |
          echo "üî® Building Next.js frontend..."
          pnpm run build
          echo "=== out/ contents ==="
          ls -la out/
          test -f out/index.html && echo "‚úÖ index.html exists" || echo "‚ùå index.html MISSING"

      - name: Build Tauri (ARM64 only, no signing)
        run: |
          echo "üî® Building Tauri for ARM64 only..."
          pnpm tauri build --target aarch64-apple-darwin --bundles app

      - name: Verify app bundle structure
        run: |
          APP_PATH="src-tauri/target/aarch64-apple-darwin/release/bundle/macos/Hablara.app"
          echo "=== App Bundle Structure ==="
          ls -la "$APP_PATH/Contents/Resources/" || echo "Resources not found"
          echo ""
          echo "=== _up_ contents ==="
          ls -la "$APP_PATH/Contents/Resources/_up_/" || echo "_up_ not found"
          echo ""
          echo "=== Check for index.html in bundle ==="
          if [ -f "$APP_PATH/Contents/Resources/_up_/index.html" ]; then
            echo "‚úÖ index.html found in bundle!"
          else
            echo "‚ùå index.html NOT in bundle!"
            echo "Searching for index.html anywhere in bundle..."
            find "$APP_PATH" -name "index.html" 2>/dev/null || echo "Not found anywhere"
          fi

      - name: Upload debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-arm64-app
          path: src-tauri/target/aarch64-apple-darwin/release/bundle/macos/Hablara.app
          retention-days: 3

  publish:
    name: Publish Release
    needs: build-universal
    runs-on: ubuntu-latest
    steps:
      - name: Publish release (remove draft status)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          echo "Publishing release $VERSION..."
          gh release edit "$VERSION" --draft=false --repo "${{ github.repository }}"
          echo "‚úÖ Release $VERSION published"

  update-homebrew:
    name: Update Homebrew Cask
    needs: publish
    runs-on: macos-14
    steps:
      - name: Update Cask in Tap
        env:
          GH_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"  # Strip 'v' prefix

          echo "üì¶ Updating Homebrew Cask to ${VERSION_NUM}..."

          # Download DMG and compute SHA256
          DMG_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/Hablara_${VERSION_NUM}_universal.dmg"
          echo "Downloading ${DMG_URL}..."
          curl -fSL -o /tmp/hablara.dmg "${DMG_URL}"
          SHA256=$(shasum -a 256 /tmp/hablara.dmg | cut -d' ' -f1)
          echo "SHA256: ${SHA256}"
          rm /tmp/hablara.dmg

          # Fetch current cask file from tap (single API call)
          JSON_RESP=$(gh api repos/fidpa/homebrew-hablara/contents/Casks/hablara.rb)
          FILE_SHA=$(echo "${JSON_RESP}" | jq -r .sha)
          CURRENT_CONTENT=$(echo "${JSON_RESP}" | jq -r .content | base64 -d)

          # Update version and sha256 (anchored to line start to avoid caveats matches)
          UPDATED_CONTENT=$(echo "${CURRENT_CONTENT}" | \
            sed -E "s/(^[[:space:]]*version )['\"][^'\"]*['\"]/\1\"${VERSION_NUM}\"/" | \
            sed -E "s/(^[[:space:]]*sha256 )['\"][^'\"]*['\"]/\1\"${SHA256}\"/")

          # Verify content actually changed (catch silent sed failures)
          if [[ "${CURRENT_CONTENT}" == "${UPDATED_CONTENT}" ]]; then
            echo "‚ö†Ô∏è Content unchanged - version may already be ${VERSION_NUM} or sed regex failed"
            exit 1
          fi

          # Push updated cask file via GitHub API
          ENCODED_CONTENT=$(echo -n "${UPDATED_CONTENT}" | base64 | tr -d '\n')
          gh api repos/fidpa/homebrew-hablara/contents/Casks/hablara.rb \
            --method PUT \
            --field message="Bump hablara to ${VERSION_NUM}" \
            --field content="${ENCODED_CONTENT}" \
            --field sha="${FILE_SHA}" \
            --silent

          echo "‚úÖ Homebrew Cask updated to ${VERSION_NUM} (sha256: ${SHA256})"
