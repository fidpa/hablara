# ============================================================================
# Hablar√° - GitHub Release Workflow
# ============================================================================
# Builds signed DMGs for macOS (arm64 + x86_64) and creates a GitHub Release.
#
# Trigger: Push a tag matching 'v*' (e.g., v1.0.3)
#
# Prerequisites:
#   - APPLE_CERTIFICATE_BASE64: Base64-encoded Developer ID certificate
#   - APPLE_CERTIFICATE_PASSWORD: Certificate password
#   - APPLE_SIGNING_IDENTITY: e.g., "Developer ID Application: ..."
#   - APPLE_ID / APPLE_PASSWORD / APPLE_TEAM_ID: For notarization (optional)
# ============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  APP_NAME: "Hablar√°"

jobs:
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
            runner: macos-14
          - target: x86_64-apple-darwin
            arch: x86_64
            runner: macos-13

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ========================================
      # Build whisper.cpp for target architecture
      # ========================================
      - name: Cache whisper model
        id: cache-whisper-model
        uses: actions/cache@v4
        with:
          path: src-tauri/models/ggml-german-turbo.bin
          key: whisper-german-turbo-1.62gb

      - name: Download whisper german-turbo model
        if: steps.cache-whisper-model.outputs.cache-hit != 'true'
        run: |
          mkdir -p src-tauri/models
          echo "‚¨áÔ∏è Downloading german-turbo model (1.62 GB)..."
          curl -L --progress-bar \
            "https://huggingface.co/cstr/whisper-large-v3-turbo-german-ggml/resolve/main/ggml-model.bin" \
            -o src-tauri/models/ggml-german-turbo.bin
          ls -lh src-tauri/models/ggml-german-turbo.bin
          echo "‚úÖ Model downloaded"

      - name: Build whisper.cpp
        run: |
          set -e
          echo "üì¶ Cloning whisper.cpp..."
          git clone --depth 1 https://github.com/ggml-org/whisper.cpp.git /tmp/whisper-build
          cd /tmp/whisper-build

          # Configure based on architecture
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            echo "üî® Building for arm64 (Metal)..."
            cmake -B build \
              -DCMAKE_OSX_ARCHITECTURES=arm64 \
              -DGGML_METAL=ON \
              -DCMAKE_BUILD_TYPE=Release \
              -DWHISPER_BUILD_EXAMPLES=ON
          else
            echo "üî® Building for x86_64..."
            cmake -B build \
              -DCMAKE_OSX_ARCHITECTURES=x86_64 \
              -DCMAKE_BUILD_TYPE=Release \
              -DWHISPER_BUILD_EXAMPLES=ON \
              -DGGML_NATIVE=OFF \
              -DGGML_METAL=OFF
          fi

          cmake --build build --config Release -j$(sysctl -n hw.ncpu)

          # Install binary
          mkdir -p $GITHUB_WORKSPACE/src-tauri/binaries
          cp build/bin/whisper-cli $GITHUB_WORKSPACE/src-tauri/binaries/whisper-${{ matrix.target }}
          chmod +x $GITHUB_WORKSPACE/src-tauri/binaries/whisper-${{ matrix.target }}

          echo "‚úÖ whisper.cpp built"
          ls -lh $GITHUB_WORKSPACE/src-tauri/binaries/
          lipo -info $GITHUB_WORKSPACE/src-tauri/binaries/whisper-${{ matrix.target }}

      # ========================================
      # Build Tauri App
      # ========================================
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Optional: Add these for code signing
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Hablar√° ${{ github.ref_name }}'
          releaseBody: |
            ## Hablar√° ${{ github.ref_name }}

            Voice Intelligence Platform - Sprache aufnehmen, transkribieren und KI-gest√ºtzt anreichern.

            ### Downloads

            | Architektur | Datei |
            |-------------|-------|
            | Apple Silicon (M1/M2/M3/M4) | `Hablar√°_*_aarch64.dmg` |
            | Intel | `Hablar√°_*_x64.dmg` |

            ### Voraussetzungen

            - macOS 12.0 oder neuer
            - [Ollama](https://ollama.com) f√ºr lokale LLM-Verarbeitung (empfohlen)

            ### Schnellstart

            ```bash
            # Ollama Setup (optional, f√ºr lokale KI)
            brew install ollama
            ollama pull qwen2.5:7b
            ```
          releaseDraft: true
          prerelease: false
          args: --target ${{ matrix.target }}

  publish:
    name: Publish Release
    needs: build-macos
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
